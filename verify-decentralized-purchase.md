# 🔍 How to Verify Purchases Go Through Proxy/Keeper Network

## Quick Answer
**YES!** Your purchases are now fully decentralized and routed through keeper nodes. Here's how to verify:

---

## 1. 🏥 Check Keeper is Running

```bash
curl http://localhost:3001/health
```

**Expected Response:**
```json
{
  "status": "healthy",
  "nodeId": "keeper-node-1",
  "walletAddress": "0x447e555CA6664bbDF5f7cd6FF4878F7c1a54f44e",
  "isActive": true
}
```

---

## 2. 📊 Monitor Keeper Logs in Real-Time

When you make a purchase in your app, you'll see logs like this in the keeper window:

```
💰 [PURCHASE] New purchase request
   Buyer: user123
   Listing: 5
   Package: 100 calls
   Payment TX: 0xabc123...
   🔍 Verifying payment transaction...
   ✅ Payment verified on block 12345
   🔑 Generating access key...
   Generated: bnb_a1b2c3d4e5f6...
   💾 Creating purchase record...
   Purchase ID: 42
   🎫 Creating API access...
   Access ID: 15
   📊 Updating listing quota...
   🔗 Initializing blockchain tracking...
   ✅ Purchase completed successfully!
```

**If you see these logs → Purchase went through keeper! ✅**

---

## 3. 🗄️ Check Database for Keeper Attribution

Run this query to see which keeper processed your purchase:

```sql
-- Check most recent purchase
SELECT 
  id,
  buyer_uid,
  listing_id,
  package_size,
  total_amount,
  transaction_hash,
  processed_by_keeper,  -- ← This shows the keeper!
  created_at
FROM purchases
ORDER BY created_at DESC
LIMIT 5;

-- Check API access generated by keeper
SELECT 
  id,
  buyer_uid,
  listing_id,
  access_key,
  total_quota,
  remaining_quota,
  created_by_keeper,  -- ← This shows which keeper generated the key!
  created_at
FROM api_access
ORDER BY created_at DESC
LIMIT 5;
```

**Expected Results:**
- `processed_by_keeper` = `"keeper-node-1"` ✅
- `created_by_keeper` = `"keeper-node-1"` ✅

If these columns are populated → Purchase was processed by keeper!

---

## 4. 📈 Check Keeper Statistics

```bash
# Get keeper stats
curl http://localhost:3001/stats

# Get purchase stats specifically
curl http://localhost:3001/purchase-stats
```

**Expected Response:**
```json
{
  "keeper": {
    "nodeId": "keeper-node-1",
    "wallet": "0x447e555CA6664bbDF5f7cd6FF4878F7c1a54f44e"
  },
  "purchases": {
    "totalProcessed": 5,
    "totalQuotaSold": 500,
    "totalRevenue": "0.5"
  },
  "recentPurchases": [
    {
      "id": 42,
      "buyer": "user123",
      "package": 100,
      "timestamp": "2025-10-12T05:20:00Z"
    }
  ]
}
```

**If `totalProcessed` increases → Keeper is processing purchases! ✅**

---

## 5. 🔗 Verify Blockchain Transactions from Keeper Wallet

Check blockchain explorer for transactions from keeper's wallet:

**Keeper Wallet:** `0x447e555CA6664bbDF5f7cd6FF4878F7c1a54f44e`

**Check on Sepolia Etherscan:**
```
https://sepolia.etherscan.io/address/0x447e555CA6664bbDF5f7cd6FF4878F7c1a54f44e
```

Look for transactions to the UsageTracking contract:
- **Contract:** `0x8385870fc0d4be14809e9e7f9e15f724426730fd`
- **Function:** `logUsage()`

**If you see transactions from keeper wallet → Blockchain logging is working! ✅**

---

## 6. 🧪 Test Purchase Flow

Create a test script to simulate a purchase:

```javascript
// test-purchase-verification.js
const testPurchase = {
  buyerId: 'test-user-123',
  listingId: 1,
  packageSize: 100,
  totalAmount: '0.1'
}

// Send to your purchase endpoint
const response = await fetch('http://localhost:3000/api/marketplace/purchase', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(testPurchase)
})

const result = await response.json()

// Check the response for keeper info
console.log('Decentralized:', result.decentralized) // Should be true
console.log('Keeper Node ID:', result.keeper?.nodeId) // Should be 'keeper-node-1'
console.log('Keeper Wallet:', result.keeper?.walletAddress)
console.log('Access Key Generated By:', result.apiAccess?.generatedByKeeper)
```

**Response will show:**
```json
{
  "success": true,
  "decentralized": true,  // ← Confirms decentralized!
  "purchase": {
    "id": 42,
    "processedBy": {
      "keeper": "keeper-node-1",  // ← Keeper info!
      "keeperWallet": "0x447e555CA6664bbDF5f7cd6FF4878F7c1a54f44e"
    }
  },
  "keeper": {
    "nodeId": "keeper-node-1",  // ← Keeper that processed it
    "walletAddress": "0x447e555CA6664bbDF5f7cd6FF4878F7c1a54f44e",
    "endpoint": "http://localhost:3001"
  }
}
```

**If response contains `keeper` object → Decentralized! ✅**

---

## 7. 🔍 Compare Old vs New Purchase Flow

### OLD (Centralized) Flow:
```
User → /api/marketplace/purchase → Main App Server → Database
                                 ↓
                            Blockchain (from user's wallet)
```

### NEW (Decentralized) Flow:
```
User → /api/marketplace/purchase → Keeper Selection → Keeper Node → Database
                                                     ↓
                                              Blockchain (from keeper's wallet)
                                              Access Key Generation
                                              Purchase Processing
```

---

## 8. 📋 Complete Verification Checklist

Run through this checklist after making a purchase:

- [ ] Keeper logs show purchase processing
- [ ] Database `purchases.processed_by_keeper` = `"keeper-node-1"`
- [ ] Database `api_access.created_by_keeper` = `"keeper-node-1"`
- [ ] Keeper stats show increased `totalProcessed` count
- [ ] Purchase response contains `decentralized: true`
- [ ] Purchase response contains `keeper` object with node info
- [ ] Access key starts with `bnb_` and is 66 characters long
- [ ] Blockchain explorer shows TX from keeper wallet (optional)

**If all checked → Your purchase is fully decentralized! 🎉**

---

## 9. 🐛 Troubleshooting

### Purchase fails with "Keeper network unavailable"
- **Cause:** Keeper node is not running
- **Fix:** Start keeper: `cd keeper-node && node server.js`

### Purchase succeeds but no keeper info in database
- **Cause:** Old purchase endpoint being used
- **Fix:** Verify `/api/marketplace/purchase/route.ts` imports `selectKeeperNode`

### Keeper logs don't show purchase
- **Cause:** Purchase not reaching keeper
- **Fix:** Check keeper health at `http://localhost:3001/health`

### Blockchain logging not working
- **Cause:** ENABLE_BLOCKCHAIN_LOGGING=false
- **Fix:** Set to `true` in `keeper-node/.env.local`

---

## 10. 💡 Real-Time Monitoring Commands

Open multiple terminal windows to monitor in real-time:

**Terminal 1 - Keeper Logs:**
```bash
cd keeper-node
node server.js
```

**Terminal 2 - Watch Keeper Stats:**
```bash
# Watch stats every 2 seconds
while ($true) { 
  curl http://localhost:3001/purchase-stats | ConvertFrom-Json | ConvertTo-Json
  Start-Sleep -Seconds 2 
}
```

**Terminal 3 - Watch Database:**
```sql
-- In psql or database client
SELECT id, buyer_uid, package_size, processed_by_keeper, created_at 
FROM purchases 
WHERE processed_by_keeper IS NOT NULL 
ORDER BY created_at DESC 
LIMIT 5;
```

**Terminal 4 - Your Main App:**
```bash
npm run dev
# Make purchases through the UI
```

---

## ✅ Summary

**Your purchases ARE going through the keeper network if:**

1. ✅ Keeper server is running on port 3001
2. ✅ Purchase response includes `"decentralized": true`
3. ✅ Database shows `processed_by_keeper` = `"keeper-node-1"`
4. ✅ Keeper logs show purchase processing
5. ✅ Keeper stats increase with each purchase

**The decentralization is COMPLETE and AUTOMATIC!** 🎉

Every purchase you make from now on will:
- Be processed by a keeper node (load-balanced)
- Generate access keys on the keeper
- Log blockchain transactions from keeper's wallet
- Store keeper attribution in database
- Provide full transparency and verification

---

## 🎯 Next Steps

1. **Add More Keepers**: Scale by running multiple keeper nodes on different ports
2. **Monitor Performance**: Track keeper response times and success rates
3. **Implement Rewards**: Pay keepers for processing purchases
4. **Add Redundancy**: Configure failover if primary keeper is down
5. **Dashboard**: Build a UI to visualize keeper network activity

Your marketplace is now fully decentralized! 🚀
